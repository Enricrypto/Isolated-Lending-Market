// Prisma schema for the LendCore lending protocol
// Database: PostgreSQL (Supabase)

generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// LEGACY — Polling-based metric snapshots (Phase 1-2 pipeline, to be retired)
// =============================================================================

model MetricSnapshot {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())

  // Multi-vault identification
  vaultAddress    String @default("0xE8323c3d293f81C71232023367Bada21137C055E") @db.VarChar(42)

  // Liquidity Depth
  availableLiquidity  Decimal @db.Decimal(78, 0)
  totalBorrows        Decimal @db.Decimal(78, 0)
  liquidityDepthRatio Decimal @db.Decimal(18, 6)
  liquiditySeverity   Int

  // Borrow Cost / APR Convexity
  utilizationRate      Decimal @db.Decimal(18, 6)
  borrowRate           Decimal @db.Decimal(18, 6)
  optimalUtilization   Decimal @db.Decimal(18, 6)
  distanceToKink       Decimal @db.Decimal(18, 6)
  aprConvexitySeverity Int

  // Oracle Deviations
  oraclePrice      Decimal @db.Decimal(78, 0)
  oracleConfidence Int
  oracleRiskScore  Int
  oracleIsStale    Boolean
  oracleSeverity   Int

  // Utilization Velocity (computed from deltas)
  utilizationDelta Decimal? @db.Decimal(18, 6)
  velocitySeverity Int?

  // Overall
  overallSeverity Int

  @@index([timestamp, vaultAddress])
  @@index([vaultAddress])
}

// =============================================================================
// NEW — Isolated Lending Market models (Phase 3+)
// =============================================================================

/// Static registry of isolated lending markets.
model Market {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // On-chain addresses (Sepolia)
  vaultAddress        String @unique @db.VarChar(42)
  marketAddress       String @db.VarChar(42)
  irmAddress          String @db.VarChar(42)
  oracleRouterAddress String @db.VarChar(42)
  loanAsset           String @db.VarChar(42)
  loanAssetDecimals   Int

  // Display metadata
  label  String
  symbol String

  // Status
  isActive Boolean @default(true)

  // Relations
  snapshots    MarketSnapshot[]
  positions    UserPositionSnapshot[]
  liquidations LiquidationEvent[]
  params       MarketParams?
}

/// Periodic market-level state snapshot.
model MarketSnapshot {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())

  // Market reference
  marketId String
  market   Market @relation(fields: [marketId], references: [id])

  // Core metrics
  totalSupply        Decimal @db.Decimal(30, 6)
  totalBorrows       Decimal @db.Decimal(30, 6)
  availableLiquidity Decimal @db.Decimal(30, 6)

  // Rates (0-1 range)
  utilizationRate    Decimal @db.Decimal(18, 6)
  borrowRate         Decimal @db.Decimal(18, 6)
  lendingRate        Decimal @db.Decimal(18, 6)
  optimalUtilization Decimal @default(0) @db.Decimal(18, 6)

  // Derived liquidity metrics
  liquidityDepthRatio Decimal @default(0) @db.Decimal(18, 6)
  distanceToKink      Decimal @default(0) @db.Decimal(18, 6)

  // Oracle
  oraclePrice      Decimal @db.Decimal(30, 6)
  oracleConfidence Int
  oracleRiskScore  Int     @default(0)
  oracleIsStale    Boolean

  // Interest tracking
  globalBorrowIndex Decimal? @db.Decimal(30, 18)

  // Per-dimension severity (0-3)
  liquiditySeverity    Int @default(0)
  aprConvexitySeverity Int @default(0)
  oracleSeverity       Int @default(0)

  // Overall severity
  overallSeverity Int

  @@index([marketId, timestamp])
  @@index([timestamp])
}

/// Per-user position snapshot within a market.
model UserPositionSnapshot {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())

  userAddress String @db.VarChar(42)
  marketId    String
  market      Market @relation(fields: [marketId], references: [id])

  collateralValue Decimal @db.Decimal(30, 6)
  totalDebt       Decimal @db.Decimal(30, 6)
  healthFactor    Decimal @db.Decimal(18, 6)
  borrowingPower  Decimal @db.Decimal(30, 6)

  @@index([userAddress, marketId])
  @@index([marketId, timestamp])
}

/// Persisted IRM and risk parameters per market.
/// Seeded from on-chain on startup; overridable by admin API.
model MarketParams {
  id       String @id @default(uuid())
  marketId String @unique
  market   Market @relation(fields: [marketId], references: [id])

  // Interest Rate Model parameters (from InterestRateModel contract)
  baseRate           Decimal @db.Decimal(18, 6)
  slope1             Decimal @db.Decimal(18, 6)
  slope2             Decimal @db.Decimal(18, 6)
  optimalUtilization Decimal @db.Decimal(18, 6)

  // Market risk parameters (from MarketV1 contract)
  lltv               Decimal @db.Decimal(18, 6)
  liquidationPenalty Decimal @db.Decimal(18, 6)
  protocolFee        Decimal @db.Decimal(18, 6)

  updatedAt DateTime @updatedAt
  updatedBy String   @default("chain") // "chain" | "admin:<address>"
}

// =============================================================================
// INDEXER STATE — Block cursor + reorg detection
// =============================================================================

/// Indexer sync cursor — one row per chain.
/// Tracks the last confirmed block that was fully processed.
model SyncState {
  id                 Int      @id @default(1)
  chainId            Int      @unique
  lastProcessedBlock Int
  lastProcessedHash  String   @db.VarChar(66)
  updatedAt          DateTime @updatedAt
}

/// Rolling window of recent block hashes for reorg detection.
/// Pruned to keep only the last REORG_BUFFER (20) blocks.
model IndexedBlock {
  blockNumber Int      @id
  blockHash   String   @db.VarChar(66)
  processedAt DateTime @default(now())
}

/// On-chain liquidation event record.
model LiquidationEvent {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())

  txHash      String @db.VarChar(66)
  blockNumber Int
  logIndex    Int

  marketId String
  market   Market @relation(fields: [marketId], references: [id])

  borrower         String  @db.VarChar(42)
  liquidator       String  @db.VarChar(42)
  debtCovered      Decimal @db.Decimal(30, 6)
  collateralSeized Decimal @db.Decimal(30, 6)
  badDebt          Decimal @db.Decimal(30, 6)

  @@unique([txHash, logIndex])
  @@index([marketId, timestamp])
  @@index([borrower])
}
